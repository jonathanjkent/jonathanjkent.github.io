---
title: "Two Goal Leads"
subtitle: "Research Update"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(survival)
library(survminer)

options(dplyr.summarise.inform=F)

d <- read_rds("~/GoogleDrive/Futbol/two_goal_leads/all_score_seq.rds") %>% mutate(season = as.numeric(str_sub(season,1,4)), time = ifelse(time>90,90,time)) 
gpg <- d %>% group_by(game) %>% slice(n()) %>% ungroup() %>% select(league,season,GH,GA) %>% replace(.,is.na(.),0) %>% mutate(goals = GH+GA) %>% group_by(league,season) %>% summarise(gpg = mean(goals))
att_def <- read_rds("~/GoogleDrive/Futbol/two_goal_leads/rs_data.rds")
final_scores <- d %>% group_by(game) %>% slice(max(row_number())) %>% ungroup() %>% select(game,GH,GA,home,away,season,league) %>% mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% mutate(league_season = paste(league,season)) %>% arrange(as.numeric(str_sub(game,9,-1)))

```

## Data in brief

The data comes from David Schoch and includes all goals scored in all matches of 10 top-flight domestic leagues in Europe from the 1990 season (except Scotland, for which data starts in 1996) through the 2021 season, plus the majority of matches in the 2022 season.

Count of matches by league and season:

```{r, echo=F}
table(final_scores$league,final_scores$season)
```

In its original form, the data is structured like so: 

```{r, echo=F}
print(d %>% select(-game,-ends_with("elo"),-league))
```

There are two main disadvantages to the data. First, with the exception of 19 goals scored in the Austrian league, 5 in the French, and 1 in the Dutch, stoppage time goals are recorded as taking place in the 90th minute. Second, the date the match was played is not included. Below I note how I have dealt with these issues.

## Danger of conceding after taking a lead

To test whether teams that have taken a two-goal lead are more likely to concede than in other situations, I run a series of Cox proportional hazards regression models where the censoring status is whether or not the leading time concedes before the match ends and the survival time is the minutes that elapse from scoring to take the lead (or bring the match level) to conceding or the final whistle.

For these models the data is reshaped like so:

```{r, echo=F}
h_con <- d %>% filter(scoring != home) %>% select(game,time) %>% rename(con_time = time)
h <- d %>% mutate(margin = GH-GA) %>% left_join(h_con, by = "game", relationship = "many-to-many") %>% mutate(prior = ifelse(con_time < time,1,0)) %>% group_by(game) %>% arrange(prior,time) %>% group_by(game,GH,GA) %>% slice(1) %>% ungroup() %>% mutate(concede = ifelse(is.na(con_time) | prior == 1,0,1)) %>% filter(scoring == home) %>% mutate(time_elap = ifelse(concede == 1, con_time-time, 90-time), leader_elo_adv = home_elo-away_elo, leader_home = 1)     

a_con <- d %>% filter(scoring != away) %>% select(game,time) %>% rename(con_time = time)
a <- d %>% mutate(margin = GA-GH) %>% left_join(a_con, by = "game", relationship = "many-to-many") %>% mutate(prior = ifelse(con_time < time,1,0)) %>% group_by(game) %>% arrange(prior,time) %>% group_by(game,GH,GA) %>% slice(1) %>% ungroup() %>% mutate(concede = ifelse(is.na(con_time) | prior == 1,0,1)) %>% filter(scoring == away) %>% mutate(time_elap = ifelse(concede == 1, con_time-time, 90-time), leader_elo_adv = away_elo-home_elo, leader_home = 0)     

concede <- bind_rows(h,a) %>% filter(margin >= 0 & margin < 5) %>% mutate(lead = paste0("lead_",margin)) %>% left_join(gpg, by = c("league","season")) %>% left_join(att_def, by = "game") %>% mutate(leader_defend = ifelse(leader_home==1,home_defend,away_defend), opp_attack = ifelse(leader_home==1,away_attack,home_attack), opp_defend = ifelse(leader_home==0,home_defend,away_defend), leader_attack = ifelse(leader_home==0,away_attack,home_attack), leader_win_pred = ifelse(leader_home==1,home_win_pred,1-home_win_pred)) %>% mutate(lead = relevel(as.factor(lead), ref = "lead_2")) 

print(concede %>% select(game,GH,GA,time,home,away,concede,time_elap,leader_home) %>% arrange(game,time) %>% slice(1:17))
```

On average, teams with large leads are more superior to their opponents than teams with small leads. To account for this, I use two different measures of team strength. First, I run a Elo model which tracks all teams in a given league from 1990 to 2022 and include the difference in Elo scores as a covariate in the model. Second, I run Rue-Salvesen models (an extension of the Dixon-Coles model) separately for each game in the data set and include the leading team's win probability as a covariate. Each approach has disadvantages. The Elo model sets each new team's score at 1500, the average score, although newly promoted teams are likely to be below-average in strength. Rue-Salvesen models, on the other hand, benefit from weighting each match based on how long ago it occurred. Because this data does not include the match date, I have instead run the models on all matches played in that league-season (before and after) expect the match in question.

The first two models compare these approaches. They also include covariates for whether the scoring team was playing at home and the goals-per-game in that league-season (to account for the overall scoring environment). For the "lead" variable, two-goal leads are the reference category. Here, I have removed all leads which were taken in the 90th minute, as the stoppage time data issue makes it impossible to determine how much time elapsed in the instances where a goal was conceded afterwards.

```{r}
summary(m1a <- coxph(Surv(time_elap, concede) ~ lead + leader_home + leader_elo_adv + gpg, data = filter(concede,time<90)))
summary(m1b <- coxph(Surv(time_elap, concede) ~ lead + leader_home + leader_win_pred + gpg, data = filter(concede,time<90)))
AIC(m1a,m1b)
```

In these models I find that teams that have taken a two-goal lead are indeed more likely to concede than teams that have leveled the match or taken a one-goal lead--and by a meaningful degree of about 10%. Teams that have taken three- or four-goal leads are even more likely to concede but, as I quantify below, the impact on the final result of conceding with such a large lead is minimal.

I also find that the model with the Rue-Salvesen predicted win percentage has a better AIC than the model using Elo scores. Here is that model, plotted.

```{r, echo=F, warning=F}
ggsurvplot(survfit(m1b, newdata = tibble(lead = c("lead_0","lead_1","lead_2","lead_3","lead_4"), gpg = mean(concede$gpg), leader_home = mean(concede$leader_home),leader_win_pred = mean(concede$leader_win_pred), leader_defend = mean(concede$leader_defend), opp_attack = mean(concede$opp_attack), leader_attack = mean(concede$leader_attack), opp_defend = mean(concede$opp_defend))),data=concede,legend.labs=c("Tied", "Up 1", "Up 2", "Up 3", "Up 4"), ggtheme = theme_minimal())
```

## The influence of attacking and defending strength

The Rue-Salvesen model also estimates parameters measuring the attacking and defending strength of each team, which can be included in the model, as well. For both attacking and defending, larger values are better. Defending, then, is how many goals against the team *prevents* compared to the average.

```{r}
m1c <- coxph(Surv(time_elap, concede) ~ lead + leader_home + leader_win_pred + leader_defend + opp_attack + gpg, data = filter(concede,time<90))
m1d <- coxph(Surv(time_elap, concede) ~ lead + leader_home + leader_win_pred + leader_defend*opp_attack + gpg, data = filter(concede,time<90))
m1e <- coxph(Surv(time_elap, concede) ~ lead + leader_home + leader_win_pred + leader_defend*opp_attack + leader_attack + opp_defend + gpg, data = filter(concede,time<90))
m1f <- coxph(Surv(time_elap, concede) ~ lead + leader_home + leader_win_pred + leader_defend*opp_attack + leader_attack*opp_defend + gpg, data = filter(concede,time<90)) # Best AIC
AIC(m1b,m1c,m1d,m1e,m1f)

summary(m1f) # Best AIC
```

Initially I only included the defending strength of the leading team and the attacking strength of the trailing team, as these would seem most relevant to whether or not the leader concedes. Checking the AICs, however, shows that including the other two parameters (and the corresponding interactions) does improve the model.

This model shows that the attacking quality of the trailing team has the biggest influence on the likelihood of conceding a goal, followed by the defending quality of the leader. Unsurprisingly, leading teams are in less danger if they are playing at home but in more danger if they play in a high-scoring league.

The leader's attacking quality and trailer's defending quality also matter, but to a lesser degree and in a way that initially seemed paradoxical. Leading teams with strong attacks are MORE likely to concede after taking a lead and trailing teams with poor defenses are also more likely to score. Modelling one-goal and two-goal leads separately helps reveal why.

## Comparing one-goal leads and two-goal leads

```{r}
summary(coxph(Surv(time_elap, concede) ~ leader_home + leader_win_pred + leader_defend+opp_attack + leader_attack+opp_defend + gpg, data = filter(concede,time<90 & lead == "lead_1")))
summary(coxph(Surv(time_elap, concede) ~ leader_home + leader_win_pred + leader_defend+opp_attack + leader_attack+opp_defend + gpg, data = filter(concede,time<90 & lead == "lead_2")))
```

The biggest difference between the two models is that the paradoxical hazard of having a strong attack while leading is present for one-goal leads but disappears for two-goal leads.

Why?

I think what is happening here is that teams with one-goal leads that have quality attacks are more likely to extend their leads. And then, subsequently, they will have two- or even three/four-goal leads and thus be more likely (per the previous models) to concede before the game ends (which is the censoring condition in this version of the data). On the contrary, leading teams that are not less likely to extend their lead, due to a poor attack or a quality opposing defense, are less likely to face the danger of a two-goal lead and instead must defend their one-goal lead vigorously. However, the paradoxical coefficients persist even after adding the number of additional goals scored in the match by the leading team as an additional covariate.

Putting this "paradox" aside, the other difference between one-goal and two-goal leads is the degree to which the trailing team's attacking quality presents a hazard. Trailing teams with good attacks are more dangerous when trailing by two than by one. Perhaps this indicates that teams with two-goal leads become complacent about the oppositions attacking prowess. By taking a two-goal lead they may feel confident that they are *generally* superior to their opponent when what they have demonstrated is only that they are superior to their opponents defense--not its attack, necessarily. 

## Stages of the game

Compared to one-goal leads, two-goal leads are especially dangerous in the late stages of a match. Here I include a variable for game stage in which the early stage is minutes 1-39, the middle stage is minutes 40-79, and the late stage is the final 10 minutes plus stoppage time.

```{r}
concede <- concede %>% mutate(stage = ifelse(time<40,"early",ifelse(time>=80,"late","middle")))

summary(coxph(Surv(time_elap, concede) ~ leader_home + leader_win_pred + leader_defend+opp_attack + leader_attack+opp_defend + gpg + stage, data = filter(concede,time<90 & lead == "lead_1")))
summary(coxph(Surv(time_elap, concede) ~ leader_home + leader_win_pred + leader_defend+opp_attack + leader_attack+opp_defend + gpg + stage, data = filter(concede,time<90 & lead == "lead_2")))
```

We see that one-goal leads may be slightly more vulnerable in the middle stage but that two-goal leads are substantially more dangerous at the end. It is unsurprising that teams with two-goal leads may let their guard down in the waning minutes. This appears to be a major factor in the difference in danger between one- and two-goal leads. If we artificially "end" the match after the 85th minute, two-goal leads are still more dangerous than leveled scores but indistinguishable from one-goal leads. 

```{r, echo=F}
concede_to_85 <- concede %>% mutate(con_time = ifelse(is.na(con_time),-99,con_time), concede = ifelse(con_time>85,0,concede)) %>% filter(time <= 85) 

summary(coxph(Surv(time_elap, concede) ~ lead + leader_home + leader_win_pred + leader_defend*opp_attack + leader_attack*opp_defend + gpg, data = concede_to_85))
``` 

## Two-goal leads are still quite safe

Two-goal leads, of course, are still safer than one-goal leads if we focus on holding the lead and winning the match. Here survival is whether or not the match goes level, instead of whether or not a goal is conceded. For these models, including leader's attack and opponent's defense worsens the AIC and, when included, there is no evidence of the "paradox" seen in the concede models. This gives further credence to the explanation I proposed.

```{r, echo=F}
l_paste <- function(x){paste0(x,"_lead")}

lead_1 <- d %>% filter(abs(GH-GA)==1) %>% select(game,GH,GA,time) %>% rename_with(l_paste,GH:time)
lead_1 <- d %>% left_join(lead_1, by = "game", relationship = "many-to-many") %>% na.omit() %>% mutate(game_lead = paste0(game,"-",time_lead),lead_lost = ifelse(time > time_lead & GH==GA,1,0), time_elap = ifelse(lead_lost == 1, time-time_lead, 90-time_lead)) %>% group_by(game,league,home,away,game_lead,season,home_elo,away_elo,GH_lead,GA_lead) %>% summarise(lead_lost = max(lead_lost), time_elap = min(time_elap)) %>% ungroup() %>% mutate(leader_home = ifelse(GH_lead > GA_lead,1,0), leader_elo_adv = ifelse(leader_home==1,home_elo-away_elo,away_elo-home_elo)) %>% select(game,league,home,away,season,lead_lost,time_elap,leader_home,leader_elo_adv) %>% mutate(lead = 1)

lead_2 <- d %>% filter(abs(GH-GA)==2) %>% select(game,GH,GA,time) %>% rename_with(l_paste,GH:time)
lead_2 <- d %>% left_join(lead_2, by = "game", relationship = "many-to-many") %>% na.omit() %>% mutate(game_lead = paste0(game,"-",time_lead),lead_lost = ifelse(time > time_lead & GH==GA,1,0), time_elap = ifelse(lead_lost == 1, time-time_lead, 90-time_lead)) %>% group_by(game,league,home,away,game_lead,season,home_elo,away_elo,GH_lead,GA_lead) %>% summarise(lead_lost = max(lead_lost), time_elap = min(time_elap)) %>% ungroup() %>% mutate(leader_home = ifelse(GH_lead > GA_lead,1,0), leader_elo_adv = ifelse(leader_home==1,home_elo-away_elo,away_elo-home_elo), is_2_0 = ifelse(GH_lead == 2 & GA_lead == 0,1,0)) %>% select(game,home,away,league,season,lead_lost,time_elap,leader_home,leader_elo_adv,is_2_0) %>% mutate(lead = 2)

lead_3 <- d %>% filter(abs(GH-GA)==3) %>% select(game,GH,GA,time) %>% rename_with(l_paste,GH:time)
lead_3 <- d %>% left_join(lead_3, by = "game", relationship = "many-to-many") %>% na.omit() %>% mutate(game_lead = paste0(game,"-",time_lead),lead_lost = ifelse(time > time_lead & GH==GA,1,0), time_elap = ifelse(lead_lost == 1, time-time_lead, 90-time_lead)) %>% group_by(game,league,home,away,game_lead,season,home_elo,away_elo,GH_lead,GA_lead) %>% summarise(lead_lost = max(lead_lost), time_elap = min(time_elap)) %>% ungroup() %>% mutate(leader_home = ifelse(GH_lead > GA_lead,1,0), leader_elo_adv = ifelse(leader_home==1,home_elo-away_elo,away_elo-home_elo)) %>% select(game,league,home,away,season,lead_lost,time_elap,leader_home,leader_elo_adv) %>% mutate(lead = 3)

lead_4 <- d %>% filter(abs(GH-GA)==4) %>% select(game,GH,GA,time) %>% rename_with(l_paste,GH:time)
lead_4 <- d %>% left_join(lead_4, by = "game", relationship = "many-to-many") %>% na.omit() %>% mutate(game_lead = paste0(game,"-",time_lead),lead_lost = ifelse(time > time_lead & GH==GA,1,0), time_elap = ifelse(lead_lost == 1, time-time_lead, 90-time_lead)) %>% group_by(game,league,home,away,game_lead,season,home_elo,away_elo,GH_lead,GA_lead) %>% summarise(lead_lost = max(lead_lost), time_elap = min(time_elap)) %>% ungroup() %>% mutate(leader_home = ifelse(GH_lead > GA_lead,1,0), leader_elo_adv = ifelse(leader_home==1,home_elo-away_elo,away_elo-home_elo)) %>% select(game,league,home,away,season,lead_lost,time_elap,leader_home,leader_elo_adv) %>% mutate(lead = 4)

leads <- bind_rows(lead_1,lead_2,lead_3,lead_4) %>% mutate(lead = paste0("lead_",lead)) %>% left_join(gpg, by = c("league","season")) %>% left_join(att_def, by = "game") %>% mutate(leader_defend = ifelse(leader_home==1,home_defend,away_defend), opp_attack = ifelse(leader_home==1,away_attack,home_attack), opp_defend = ifelse(leader_home==0,home_defend,away_defend), leader_attack = ifelse(leader_home==0,away_attack,home_attack), leader_win_pred = ifelse(leader_home==1,home_win_pred,1-home_win_pred)) %>% mutate(lead = relevel(as.factor(lead), ref = "lead_2"))

#summary(m2a <- coxph(Surv(time_elap, lead_lost) ~ lead + leader_home + leader_elo_adv + gpg, data = leads))
#summary(m2b <- coxph(Surv(time_elap, lead_lost) ~ lead + leader_home + leader_win_pred + gpg, data = leads))
#summary(m2c <- coxph(Surv(time_elap, lead_lost) ~ lead + leader_home + leader_win_pred + leader_defend + opp_attack + gpg, data = leads))
summary(m2d <- coxph(Surv(time_elap, lead_lost) ~ lead + leader_home + leader_win_pred + leader_defend*opp_attack + gpg, data = leads)) # Best AIC
#summary(m2e <- coxph(Surv(time_elap, lead_lost) ~ lead + leader_home + leader_win_pred + leader_defend*opp_attack + opp_defend + leader_attack + gpg, data = leads))
#summary(m2f <- coxph(Surv(time_elap, lead_lost) ~ lead + leader_home + leader_win_pred + leader_defend*opp_attack + opp_defend*leader_attack + gpg, data = leads))
#AIC(m2a,m2b,m2c,m2d,m2e,m2f)
ggsurvplot(survfit(m2d, newdata = tibble(lead = c("lead_1","lead_2","lead_3","lead_4"),leader_home = mean(leads$leader_home), leader_win_pred = mean(leads$leader_win_pred), leader_defend = mean(leads$leader_defend), opp_attack = mean(leads$opp_attack), gpg = mean(leads$gpg))),data=leads,legend.labs=c("Up 1", "Up 2", "Up 3", "Up 4"),ggtheme = theme_minimal())
```

## Takeaways

- Teams that have taken a two-goal lead are more likely to subsequently concede a goal than if they have taken a one-goal lead or gone level
- The relative danger of two-goal leads is greatest in the final stages of a match
- The quality of the trailing team's attack is a significant factor in whether or not teams with two-goal leads concede
- Two-goal leads are much less likely to eventually go level than one goal leads

## Next steps

- Look for other ways to get at the "why" question with this data
- Check if two-goal leads are even more dangerous in youth soccer (I already scraped the data, so I might as well)
- In the longer term, use event/tracking data to go deeper, probably as other papers. For example, a paper on substitution dynamics based on score margin or a paper on shot locations based on score margin.