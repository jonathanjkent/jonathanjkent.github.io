---
title: "Dangerous Two Goal Leads"
output: html_document
date: "2023-04-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(tidyverse)
options(dplyr.summarise.inform=F)
```

## Introduction

This is a brief investigation (so far) of the dynamics of comebacks in soccer and other sports. A few weeks ago, in the Friday soccer analytics seminar, someone mentioned the myth that "a two goal lead is the most dangerous in soccer." It's easy to laugh off the myth, because teams are obviously better off with a two goal lead than if they were leading by a single goal. But it made me wonder if there is any element of truth in the saying. Are two goal leads less safe than we might expect, in some way?

To look into it, I have gathered the scoring summaries (minute at which each goal was scored) of all Premier League games dating back to 1992. For comparison purposes, I also have data for a random sample of Bundesliga and National Hockey League games for the same period and all National Football League games since 1999.

Also inspired by a Friday seminar conversation, I use negative binomial models which seem to fit the data quite well. There may be a better model possible, but I think this works for exploring the data.

## Premier League

```{r eng}
d <- read_rds("~/GoogleDrive/Futbol/leads_data_eng1.rds") %>% filter(match != "/en/matches/") %>% mutate(date = mark::str_extract_date(match, format = "%B-%d-%Y"), match = ifelse(is.na(date),paste0(str_sub(match,1,-22),0,str_sub(match,-21,-1)),match), date = mark::str_extract_date(match, format = "%B-%d-%Y"), minute = as.numeric(gsub("\\D","",gsub("\\+.*","",minute))), home.score = as.numeric(home.score), away.score = as.numeric(away.score))

preds <- tibble(minute = as.double(), pred = as.double(), lead = as.character(), model = as.character())

for (i in 1:3){
  t <- d %>% mutate(tie = ifelse(home.score==away.score,1,0),lead = ifelse(abs(home.score-away.score)==i,1,0)) %>% group_by(match) %>% mutate(cum_tie = cumsum(tie))  %>% group_by(match,lead,cum_tie) %>% slice(1) %>% arrange(minute)%>% group_by(match) %>% mutate(lead = cumsum(lead))%>% group_by(match,lead) %>% summarise(minute = min(minute), tie = max(tie)) %>% filter(lead > 0)
  assign(paste0("lead_",i),t)
  
  suppressWarnings(m1<-MASS::glm.nb(tie ~ minute,t))
  suppressWarnings(m2<-MASS::glm.nb(tie ~ minute + I(minute^2),t))
  suppressWarnings(m3<-MASS::glm.nb(tie ~ minute + I(minute^2) + I(minute^3),t))
  aic <- tibble(m=c("m1","m2","m3"),aic = c(AIC(m1),AIC(m2),AIC(m3))) %>% arrange(aic)
  m<-mget(aic$m[1])[[1]]
  preds <- bind_rows(preds,tibble(minute=min(t$minute):max(t$minute)) %>% mutate(pred = exp(predict(m,.)), lead = paste(i,"goals"), model = aic$m[1], lead = ifelse(str_sub(lead,1,1)==1, str_sub(lead,1,-2),lead)))
}

agg <- bind_rows(mget(str_subset(ls(),"lead_")), .id = "id") %>% ungroup() %>% mutate(lead = paste(str_sub(id,-1,-1),"goals"), lead = ifelse(str_sub(id,-1,-1)==1, str_sub(lead,1,-2),lead), minute=round(minute/3)) %>% select(minute,tie,lead) %>% group_by(minute,lead) %>% mutate(minute = minute*3) %>% summarise(pred = mean(tie))

print(ggplot() + geom_vline(xintercept = 45, alpha = .5) + geom_line(data = preds,aes(minute,pred,color=lead), linewidth = 1.2) + geom_point(data = agg, aes(minute,pred,color=lead), alpha = .2) + theme_minimal() + labs(y = "Prob. of Losing Lead", x = "Minute Lead Reached", color = "Lead"))

preds_eng <- preds %>% mutate(league = "eng")
```

For each game, I identify every instance in which a team takes a 1, 2 or 3 goal lead and whether or not that lead is eventually lost. A game could therefore be represented in this data multiple times if leads are overturned and then regained. I examine and model the data based on the time at which the lead was reached. A team which takes a 1 goal lead in the 88th minute is less likely to lose that lead than if they had taken it in the first half, for example.

In the plot above, the points represent the percentage of leads lost aggregated into three-minute-wide bins. The line is the predicted probability of losing the lead via a negative binomial model. The model includes minute, minute-squared and minute-cubed as predictors (or fewer predictors depending on the best AIC).

## Bundesliga

```{r ger}
d <- read_rds("~/GoogleDrive/Futbol/leads_data_ger1.rds") %>% filter(match != "/en/matches/") %>% mutate(date = mark::str_extract_date(match, format = "%B-%d-%Y"), match = ifelse(is.na(date),paste0(str_sub(match,1,-22),0,str_sub(match,-21,-1)),match), date = mark::str_extract_date(match, format = "%B-%d-%Y"), minute = as.numeric(gsub("\\D","",gsub("\\+.*","",minute))), home.score = as.numeric(home.score), away.score = as.numeric(away.score))

preds <- tibble(minute = as.double(), pred = as.double(), lead = as.character(), model = as.character())

for (i in 1:3){
  t <- d %>% mutate(tie = ifelse(home.score==away.score,1,0),lead = ifelse(abs(home.score-away.score)==i,1,0)) %>% group_by(match) %>% mutate(cum_tie = cumsum(tie))  %>% group_by(match,lead,cum_tie) %>% slice(1) %>% arrange(minute)%>% group_by(match) %>% mutate(lead = cumsum(lead))%>% group_by(match,lead) %>% summarise(minute = min(minute), tie = max(tie)) %>% filter(lead > 0)
  assign(paste0("lead_",i),t)
 
  suppressWarnings(m1<-MASS::glm.nb(tie ~ minute,t))
  suppressWarnings(m2<-MASS::glm.nb(tie ~ minute + I(minute^2),t))
  suppressWarnings(m3<-MASS::glm.nb(tie ~ minute + I(minute^2) + I(minute^3),t))
  aic <- tibble(m=c("m1","m2","m3"),aic = c(AIC(m1),AIC(m2),AIC(m3))) %>% arrange(aic)
  m<-mget(aic$m[1])[[1]]
  preds <- bind_rows(preds,tibble(minute=min(t$minute):max(t$minute)) %>% mutate(pred = exp(predict(m,.)), lead = paste(i,"goals"), model = aic$m[1], lead = ifelse(str_sub(lead,1,1)==1, str_sub(lead,1,-2),lead)))
}

agg <- bind_rows(mget(str_subset(ls(),"lead_")), .id = "id") %>% ungroup() %>% mutate(lead = paste(str_sub(id,-1,-1),"goals"), lead = ifelse(str_sub(id,-1,-1)==1, str_sub(lead,1,-2),lead), minute=round(minute/3)) %>% select(minute,tie,lead) %>% group_by(minute,lead) %>% mutate(minute = minute*3) %>% summarise(pred = mean(tie))

print(ggplot() + geom_vline(xintercept = 45, alpha = .5) + geom_line(data = preds,aes(minute,pred,color=lead), linewidth = 1.2) + geom_point(data = agg, aes(minute,pred,color=lead), alpha = .2) + theme_minimal() + labs(y = "Prob. of Losing Lead", x = "Minute Lead Reached", color = "Lead"))

preds_ger <- preds %>% mutate(league = "ger")
```

The Bundesliga data is not yet complete (currently, a random sample of 2028 of the 9431 total games), which may explain the odd pattern for 3 goal leads.

## National Hockey League

```{r nhl}
d <- read_rds("~/GoogleDrive/Futbol/leads_data_nhl.rds") %>% mutate(period = ifelse(period %in% c("1st Period","2nd Period","3rd Period","1st OT Period","2nd OT Period","3rd OT Period","4th OT Period","5th OT Period","Shootout"),period,NA)) %>% group_by(match) %>% fill(period) %>% filter(!team %in% c("1st Period","2nd Period","3rd Period","1st OT Period","2nd OT Period","3rd OT Period","4th OT Period","5th OT Period","Shootout") & period %in% c("1st Period","2nd Period","3rd Period")) %>% mutate(home.score = cumsum(ifelse(str_sub(match,-8,-6)==team,1,0)), away.score = cumsum(ifelse(str_sub(match,-8,-6)!=team,1,0))) %>% separate(time, into = c("min","sec")) %>% mutate(minute = (as.numeric(min)+(as.numeric(sec)/60)+(as.numeric(str_sub(period,1,1))*20-20))) %>% select(match,home.score,away.score,minute)

preds <- tibble(minute = as.double(), pred = as.double(), lead = as.character(), model = as.character())

for (i in 1:3){
  t <- d %>% mutate(tie = ifelse(home.score==away.score,1,0),lead = ifelse(abs(home.score-away.score)==i,1,0)) %>% group_by(match) %>% mutate(cum_tie = cumsum(tie))  %>% group_by(match,lead,cum_tie) %>% slice(1) %>% arrange(minute)%>% group_by(match) %>% mutate(lead = cumsum(lead))%>% group_by(match,lead) %>% summarise(minute = min(minute), tie = max(tie)) %>% filter(lead > 0)
  assign(paste0("lead_",i),t)
  
  suppressWarnings(m1<-MASS::glm.nb(tie ~ minute,t))
  suppressWarnings(m2<-MASS::glm.nb(tie ~ minute + I(minute^2),t))
  suppressWarnings(m3<-MASS::glm.nb(tie ~ minute + I(minute^2) + I(minute^3),t))
  aic <- tibble(m=c("m1","m2","m3"),aic = c(AIC(m1),AIC(m2),AIC(m3))) %>% arrange(aic)
  m<-mget(aic$m[1])[[1]]
  preds <- bind_rows(preds,tibble(minute=min(t$minute):max(t$minute)) %>% mutate(pred = exp(predict(m,.)), lead = paste(i,"goals"), model = aic$m[1], lead = ifelse(str_sub(lead,1,1)==1, str_sub(lead,1,-2),lead)))
}

agg <- bind_rows(mget(str_subset(ls(),"lead_")), .id = "id") %>% ungroup() %>% mutate(lead = paste(str_sub(id,-1,-1),"goals"), lead = ifelse(str_sub(id,-1,-1)==1, str_sub(lead,1,-2),lead), minute=round(minute/3)) %>% select(minute,tie,lead) %>% group_by(minute,lead) %>% mutate(minute = minute*3) %>% summarise(pred = mean(tie))

print(ggplot() + geom_vline(xintercept = c(20,40), alpha = .5) + geom_line(data = preds,aes(minute,pred,color=lead), linewidth = 1.2) + geom_point(data = agg, aes(minute,pred,color=lead), alpha = .2) + theme_minimal() + labs(y = "Prob. of Losing Lead", x = "Minute Lead Reached", color = "Lead"))

preds_nhl <- preds %>% mutate(league = "nhl")
```

If there is anything special or strange about 2 goal leads in soccer, it might be revealed by a comparison to other sports. First, data from the NHL alone.

## National Football League

```{r nfl}
d <- read_rds("~/GoogleDrive/Futbol/leads_data_nfl.rds") %>% filter(total_home_score + total_away_score > 0) %>% mutate(minute = (3600-game_seconds_remaining)/60) %>% select(-game_seconds_remaining)

preds <- tibble(minute = as.double(), pred = as.double(), lead = as.character(), model = as.character())

for (i in c(7,14,21)){
  h <- d %>% group_by(game_id) %>% mutate(lead = ifelse((total_home_score-total_away_score)>=i,1,0), tie = ifelse(total_home_score<=total_away_score,1,0), cum_tie = cumsum(tie)) %>% group_by(game_id,lead,cum_tie) %>% slice(1) %>% arrange(minute) %>% group_by(game_id) %>% mutate(lead = cumsum(lead)) %>% group_by(game_id,lead) %>% summarise(minute = min(minute), tie = max(tie)) %>% filter(lead > 0)
  a <- d %>% group_by(game_id) %>% mutate(lead = ifelse((total_away_score-total_home_score)>=i,1,0), tie = ifelse(total_away_score<=total_home_score,1,0), cum_tie = cumsum(tie)) %>% group_by(game_id,lead,cum_tie) %>% slice(1) %>% arrange(minute) %>% group_by(game_id) %>% mutate(lead = cumsum(lead)) %>% group_by(game_id,lead) %>% summarise(minute = min(minute), tie = max(tie)) %>% filter(lead > 0)
  t <- bind_rows(h,a)
  assign(paste0("lead_",(i/7)),t)
  suppressWarnings(m1<-MASS::glm.nb(tie ~ minute,t))
  suppressWarnings(m2<-MASS::glm.nb(tie ~ minute + I(minute^2),t))
  suppressWarnings(m3<-MASS::glm.nb(tie ~ minute + I(minute^2) + I(minute^3),t))
  aic <- tibble(m=c("m1","m2","m3"),aic = c(AIC(m1),AIC(m2),AIC(m3))) %>% arrange(aic)
  m<-mget(aic$m[1])[[1]]
  preds <- bind_rows(preds,tibble(minute=min(t$minute):max(t$minute)) %>% mutate(pred = exp(predict(m,.)), lead = paste((i/7),"scores"), model = aic$m[1], lead = ifelse(str_sub(lead,1,1)==1, str_sub(lead,1,-2),lead)))
}

agg <- bind_rows(mget(str_subset(ls(),"lead_")), .id = "id") %>% ungroup() %>% mutate(lead = paste(str_sub(id,-1,-1),"scores"), lead = ifelse(str_sub(id,-1,-1)==1, str_sub(lead,1,-2),lead), minute=round(minute/3)) %>% select(minute,tie,lead) %>% group_by(minute,lead) %>% mutate(minute = minute*3) %>% summarise(pred = mean(tie))

print(ggplot() + geom_vline(xintercept = 30, alpha = .5) + geom_line(data = preds,aes(minute,pred,color=lead), linewidth = 1.2) + geom_point(data = agg, aes(minute,pred,color=lead), alpha = .2) + theme_minimal() + labs(y = "Prob. of Losing Lead", x = "Minute Lead Reached", color = "Lead"))

preds_nfl <- preds %>% mutate(league = "nfl")
```

What about sports with an entirely different scoring system? Here, I treat touchdowns (or touchdown-sized leads) as the equivalent to goals. So, a 1 score lead is a 7 point lead and so on. Otherwise, the method is the same.

## Comparing the Sports 

```{r compare1}
print(bind_rows(preds_eng,preds_ger,preds_nhl,preds_nfl) %>% mutate(lead = paste(str_sub(lead,1,1),"Score Lead"), pct_left = ifelse(league %in% c("eng","ger"),minute/90,minute/60), league = case_when(league == "eng" ~ "Soccer (Premier League)", league == "ger" ~ "Soccer (Bundesliga)", league == "nhl" ~ "Hockey (NHL)", league == "nfl" ~ "Am. Football (NFL)")) %>% ggplot(aes(pct_left,pred,color=league)) + geom_line(linewidth = 1.2) + facet_wrap(~lead) + theme_minimal() + labs(y = "Prob. of Losing Lead", x = "Time Elapsed (%) When Lead Reached", color = NULL) + theme(legend.position="bottom"))
```

For 1 score leads, the pattern in both soccer leagues and in hockey seems to be quite similar, though leads are a bit less safe in the higher scoring environment of the NHL. For 3 score leads, the data is a bit wonky as there just aren't that many comebacks of that magnitude (about 3.8% of 3 score leads are lost in this data, which is more than I would have imagined). For 2 score leads, however, there does seem to be a bit of a different pattern for the two soccer leagues compared to the other sports. Let's zoom in.

```{r compare2}
d <- bind_rows(preds_eng,preds_ger,preds_nhl,preds_nfl) %>% filter(str_sub(lead,1,1) == 2) %>% mutate(pct_left = ifelse(league %in% c("eng","ger"),minute/90,minute/60), league = case_when(league == "eng" ~ "Soccer (Premier League)", league == "ger" ~ "Soccer (Bundesliga)", league == "nhl" ~ "Hockey (NHL)", league == "nfl" ~ "Am. Football (NFL)"))

print(ggplot() + geom_rect(aes(xmin = .17, xmax = .58, ymin = .09, ymax = .17), alpha = 0.1) + geom_line(data=d,aes(pct_left,pred,color=league),linewidth = 1.2) + theme_minimal() + labs(y = "Prob. of Losing Lead", x = "Time Elapsed (%) When Lead Reached", color = NULL) + theme(legend.position="bottom"))
```

Whereas in American football and hockey, the safety of a 2 score lead steadily progresses as time elapses, in soccer there is a plateau pattern that's especially clear in the Premier League data. Teams that gain a 2 goal lead in the 25th minute are barely more likely to lose that lead (12.9% in the EPL) than teams which went ahead by 2 just after halftime (11.6%). Surely a team with a 2 goal lead and less than 45 minutes to defend it should be in a substantially safer situation than a team with the same lead but 65 minutes left to defend it. Perhaps this is what makes 2 goal leads in soccer "dangerous." Either teams that take 2 goal leads in the middle of the first half rest on their laurels or teams that fall behind by 2 retain some psychological edge that keeps their hopes alive a bit longer.

